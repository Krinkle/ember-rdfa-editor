"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});var E=require("prosemirror-state"),f=require("prosemirror-view"),P=({mapping:e})=>{const t=[];return e.maps.forEach((r,s)=>{r.forEach((o,a,c,n)=>{t.push([e.slice(s+1).map(c),e.slice(s+1).map(n)])})}),t};const D=new E.PluginKey("PROSEMIRROR_INVISIBLES_PLUGIN"),F=e=>{var t;return!!((t=D.getState(e))!=null&&t.shouldShowInvisibles)},h="PM_INVISIBLES_ACTION",k=e=>e.getMeta(h),O="SET_SHOW_INVISIBLES_STATE",N="BLUR_DOCUMENT",T=e=>({type:O,payload:{shouldShowInvisibles:e}}),H=e=>({type:N,payload:{isFocused:e}}),x=(e,t)=>{if(!t)return e;switch(t.type){case O:return{...e,shouldShowInvisibles:t.payload.shouldShowInvisibles};case N:return{...e,shouldShowLineEndSelectionDecorations:t.payload.isFocused};default:return e}},V=()=>(e,t)=>{var r;return t&&t(e.tr.setMeta(h,T(!((r=D.getState(e))!=null&&r.shouldShowInvisibles)))),!0},z=e=>(t,r)=>(r&&r(t.tr.setMeta(h,T(e))),!0),U=e=>(t,r)=>(r&&r(t.tr.setMeta(h,H(e))),!0),b={setActiveState:z,toggleActiveState:V,setFocusedState:U};var L=(e,t,r)=>{const s=[];return r.nodesBetween(e,t,(o,a)=>{var c;if(o.isText){const n=Math.max(e,a)-a;s.push({pos:a+n,text:((c=o.text)==null?void 0:c.slice(n,t-a))||""})}}),s},y=(e,t,r=!1)=>{const s=()=>{const o=document.createElement("span");if(o.classList.add("invisible"),o.classList.add(`invisible--${t}`),r){o.classList.add("invisible--is-selected");const a=document.createElement("span");a.classList.add("invisible__selected-marker"),o.appendChild(a)}return o};return f.Decoration.widget(e,s,{marks:[],key:`${t}${r?"-selected":""}`,type:t,side:1e3})};const C={NODE:"NODE",CHAR:"CHAR"},_=(e,t)=>({type:C.CHAR,createDecorations:(r,s,o,a)=>L(r,s,o).reduce((c,{pos:n,text:u})=>u.split("").reduce((i,l,d)=>t(l)?i.remove(a.find(n+d,n+d,S=>S.type===e)).add(o,[y(n+d,e)]):i,c),a)}),p=(e,t,r)=>({type:C.NODE,createDecorations:(s,o,a,c,n,u)=>{let i=c;return a.nodesBetween(s,o,(l,d)=>{if(r(l)){const S=t(l,d),v=i.find(d,d+l.nodeSize-1,A=>A.type===e),g=(n==null?void 0:n.from)===(n==null?void 0:n.to),m=!!(n&&S>=n.from&&S<=n.to)&&n.to>=d+l.nodeSize,I=u&&m&&!g;return i=i.remove(v).add(a,[y(S,e,I)]),!1}}),i}}),W=e=>e===" ";var $=_("space",W);const q=e=>e.type===e.type.schema.nodes.hard_break;var K=p("break",(e,t)=>t,q);const j=e=>e.type===e.type.schema.nodes.paragraph;var G=p("par",(e,t)=>t+e.nodeSize-1,j);const J=e=>e==="\xA0";var Q=_("nb-space",J);const X=e=>e.type===e.type.schema.nodes.heading;var Y=p("heading",(e,t)=>t+e.nodeSize-1,X);const Z=(e,{shouldShowInvisibles:t=!0,displayLineEndSelection:r=!1}={})=>new E.Plugin({key:D,state:{init:(s,o)=>{const{from:a,to:c}=new E.AllSelection(o.doc),n=e.reduce((u,{createDecorations:i})=>i(a,c,o.doc,u,o.selection,r),f.DecorationSet.empty);return{shouldShowInvisibles:t,shouldShowLineEndSelectionDecorations:!0,decorations:n}},apply:(s,o,a,c)=>{const n=x(o,k(s)),u=o.shouldShowLineEndSelectionDecorations===n.shouldShowLineEndSelectionDecorations,i=!s.docChanged&&a.selection===c.selection;if(u&&i)return n;const l=P(s),d=[[s.selection.from,s.selection.to],[a.selection.from,Math.min(a.selection.to,s.doc.nodeSize-2)]],S=l.concat(d),v=r&&n.shouldShowLineEndSelectionDecorations,g=e.reduce((w,{createDecorations:m,type:I})=>(I==="NODE"?S:l).reduce((R,[B,M])=>m(B,M,s.doc,R,s==null?void 0:s.selection,v),w),n.decorations.map(s.mapping,c.doc));return{...n,decorations:g}}},props:{decorations:function(s){const{shouldShowInvisibles:o,decorations:a}=this.getState(s)||{};return o?a:f.DecorationSet.empty},handleDOMEvents:{blur:(s,o)=>(document.activeElement===o.target||b.setFocusedState(!1)(s.state,s.dispatch),!1),focus:s=>(b.setFocusedState(!0)(s.state,s.dispatch),!1)}}});exports.commands=b;exports.createDeco=y;exports.createInvisibleDecosForCharacter=_;exports.createInvisibleDecosForNode=p;exports.createInvisiblesPlugin=Z;exports.hardBreak=K;exports.heading=Y;exports.nbSpace=Q;exports.paragraph=G;exports.selectActiveState=F;exports.space=$;exports.textBetween=L;
